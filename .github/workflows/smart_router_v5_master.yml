name: Smart Router V5 Master Pipeline

on:
  workflow_dispatch:
    inputs:
      task_type:
        description: 'Task type for routing'
        required: true
        type: choice
        options:
          - report_generation
          - bulk_scraping
          - data_enrichment
          - property_analysis
          - lien_analysis
          - max_bid_calculation
          - market_evaluation
      prompt:
        description: 'Task prompt/instructions'
        required: true
        default: 'Analyze December 10 foreclosure auction properties'
      force_tier:
        description: 'Force specific tier (optional)'
        required: false
        type: choice
        options:
          - auto
          - free
          - ultra_cheap
          - budget
          - production
          - critical

jobs:
  route_and_execute:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install httpx

      - name: Execute via Smart Router V5
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python << 'PYTHON'
          import os
          import json
          import httpx
          from datetime import datetime

          # API Keys
          GOOGLE_API_KEY = os.environ.get("GOOGLE_API_KEY", "")
          ANTHROPIC_API_KEY = os.environ.get("ANTHROPIC_API_KEY", "")
          DEEPSEEK_API_KEY = os.environ.get("DEEPSEEK_API_KEY", "")

          # Tier routing table
          TASK_ROUTING = {
              "report_generation": "free",
              "bulk_scraping": "free",
              "data_enrichment": "free",
              "property_analysis": "free",
              "lien_analysis": "ultra_cheap",
              "max_bid_calculation": "critical",
              "market_evaluation": "production"
          }

          # Model configs
          MODELS = {
              "free": {"name": "gemini-2.5-flash", "provider": "google", "cost": 0.0},
              "ultra_cheap": {"name": "deepseek-chat", "provider": "deepseek", "cost": 0.28},
              "budget": {"name": "claude-3-haiku", "provider": "anthropic", "cost": 0.25},
              "production": {"name": "claude-sonnet-4", "provider": "anthropic", "cost": 3.0},
              "critical": {"name": "claude-opus-4", "provider": "anthropic", "cost": 15.0}
          }

          def call_gemini(prompt: str) -> dict:
              """FREE tier - Gemini 2.5 Flash (1M context)"""
              url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key={GOOGLE_API_KEY}"
              payload = {"contents": [{"parts": [{"text": prompt}]}], "generationConfig": {"maxOutputTokens": 8192}}
              response = httpx.post(url, json=payload, timeout=120)
              response.raise_for_status()
              result = response.json()
              usage = result.get("usageMetadata", {})
              return {
                  "content": result["candidates"][0]["content"]["parts"][0]["text"],
                  "tokens": usage.get("promptTokenCount", 0) + usage.get("candidatesTokenCount", 0),
                  "cost": 0.0
              }

          def call_deepseek(prompt: str) -> dict:
              """ULTRA_CHEAP tier - DeepSeek V3.2"""
              if not DEEPSEEK_API_KEY:
                  print("‚ö†Ô∏è DEEPSEEK_API_KEY not set, falling back to FREE tier")
                  return call_gemini(prompt)
              url = "https://api.deepseek.com/v1/chat/completions"
              payload = {"model": "deepseek-chat", "messages": [{"role": "user", "content": prompt}], "max_tokens": 8192}
              headers = {"Authorization": f"Bearer {DEEPSEEK_API_KEY}"}
              response = httpx.post(url, json=payload, headers=headers, timeout=120)
              response.raise_for_status()
              result = response.json()
              usage = result.get("usage", {})
              tokens = usage.get("prompt_tokens", 0) + usage.get("completion_tokens", 0)
              return {
                  "content": result["choices"][0]["message"]["content"],
                  "tokens": tokens,
                  "cost": tokens * 0.35 / 1_000_000
              }

          def call_anthropic(prompt: str, model: str) -> dict:
              """Anthropic tiers - Haiku/Sonnet/Opus"""
              if not ANTHROPIC_API_KEY:
                  print("‚ö†Ô∏è ANTHROPIC_API_KEY not set, falling back to FREE tier")
                  return call_gemini(prompt)
              
              model_map = {
                  "claude-3-haiku": "claude-3-haiku-20240307",
                  "claude-sonnet-4": "claude-sonnet-4-20250514",
                  "claude-opus-4": "claude-opus-4-20250514"
              }
              
              url = "https://api.anthropic.com/v1/messages"
              payload = {"model": model_map.get(model, model), "max_tokens": 8192, "messages": [{"role": "user", "content": prompt}]}
              headers = {"x-api-key": ANTHROPIC_API_KEY, "anthropic-version": "2023-06-01", "content-type": "application/json"}
              response = httpx.post(url, json=payload, headers=headers, timeout=120)
              response.raise_for_status()
              result = response.json()
              usage = result.get("usage", {})
              tokens = usage.get("input_tokens", 0) + usage.get("output_tokens", 0)
              cost_map = {"claude-3-haiku": 0.75, "claude-sonnet-4": 9.0, "claude-opus-4": 45.0}
              return {
                  "content": result["content"][0]["text"],
                  "tokens": tokens,
                  "cost": tokens * cost_map.get(model, 1.0) / 1_000_000
              }

          def smart_route(prompt: str, task_type: str, force_tier: str = "auto") -> dict:
              """Smart Router V5 - Route to optimal tier"""
              
              # Determine tier
              if force_tier and force_tier != "auto":
                  tier = force_tier
              else:
                  tier = TASK_ROUTING.get(task_type, "budget")
              
              model_config = MODELS[tier]
              
              print(f"üéØ Routing: {task_type} ‚Üí {tier.upper()} tier ‚Üí {model_config['name']}")
              
              # Route to provider
              if tier == "free":
                  result = call_gemini(prompt)
              elif tier == "ultra_cheap":
                  result = call_deepseek(prompt)
              else:
                  result = call_anthropic(prompt, model_config["name"])
              
              result["tier"] = tier
              result["model"] = model_config["name"]
              return result

          # Execute
          task_type = "${{ inputs.task_type }}"
          prompt = "${{ inputs.prompt }}"
          force_tier = "${{ inputs.force_tier }}" or "auto"

          print("=" * 70)
          print("üöÄ SMART ROUTER V5 - BidDeed.AI")
          print("=" * 70)
          print(f"üìã Task: {task_type}")
          print(f"üéöÔ∏è Force Tier: {force_tier}")
          print(f"‚è∞ Time: {datetime.now().isoformat()}")
          print("=" * 70)

          full_prompt = f"""
          BidDeed.AI Analysis Request
          Task Type: {task_type}
          
          {prompt}
          
          Provide detailed, actionable analysis.
          
          Author: Ariel Shapira, Solo Founder
          Real Estate Developer & Founder, Everest Capital USA
          """

          result = smart_route(full_prompt, task_type, force_tier)

          print(f"\nüìä RESULT ({result['tier'].upper()} tier)")
          print("=" * 70)
          print(result["content"][:4000])
          print("\n" + "=" * 70)
          print(f"‚úÖ Model: {result['model']}")
          print(f"üìà Tokens: {result['tokens']}")
          print(f"üí∞ Cost: ${result['cost']:.4f}")
          
          # Calculate savings
          opus_equivalent = result['tokens'] * 45.0 / 1_000_000
          savings = opus_equivalent - result['cost']
          print(f"üíµ Savings vs Opus: ${savings:.4f}")
          PYTHON

      - name: Log execution to Supabase
        env:
          SUPABASE_URL: https://mocerqjnksmhcjzxrewo.supabase.co
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
        run: |
          curl -s -X POST "$SUPABASE_URL/rest/v1/insights" \
            -H "apikey: $SUPABASE_KEY" \
            -H "Authorization: Bearer $SUPABASE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{
              "category": "mcp_reference",
              "subcategory": "smart_router_execution",
              "title": "Smart Router V5 executed: ${{ inputs.task_type }}",
              "content": "Task: ${{ inputs.task_type }}, Tier: ${{ inputs.force_tier }}",
              "metadata": {"task_type": "${{ inputs.task_type }}", "force_tier": "${{ inputs.force_tier }}"}
            }' || echo "Logged"
