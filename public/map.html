<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BidDeed.AI - Brevard County Foreclosure Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0f172a; color: #f8fafc; }
    
    .header {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #334155;
    }
    .logo { font-size: 1.5rem; font-weight: 700; color: #38bdf8; }
    .logo span { color: #f8fafc; }
    .nav-links { display: flex; gap: 1.5rem; }
    .nav-links a { color: #94a3b8; text-decoration: none; font-weight: 500; transition: color 0.2s; }
    .nav-links a:hover, .nav-links a.active { color: #38bdf8; }
    
    .container { display: flex; height: calc(100vh - 64px); }
    
    .sidebar {
      width: 380px;
      background: #1e293b;
      border-right: 1px solid #334155;
      overflow-y: auto;
      padding: 1rem;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #334155;
    }
    .sidebar-title { font-size: 1.1rem; font-weight: 600; }
    .property-count {
      background: #38bdf8;
      color: #0f172a;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .filters { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #334155;
      background: transparent;
      color: #94a3b8;
      border-radius: 0.5rem;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .filter-btn:hover { border-color: #38bdf8; color: #38bdf8; }
    .filter-btn.active { background: #38bdf8; border-color: #38bdf8; color: #0f172a; }
    .filter-btn.bid { border-color: #22c55e; color: #22c55e; }
    .filter-btn.bid.active { background: #22c55e; color: #0f172a; }
    .filter-btn.review { border-color: #eab308; color: #eab308; }
    .filter-btn.review.active { background: #eab308; color: #0f172a; }
    .filter-btn.skip { border-color: #ef4444; color: #ef4444; }
    .filter-btn.skip.active { background: #ef4444; color: #fff; }
    
    .property-list { display: flex; flex-direction: column; gap: 0.75rem; }
    .property-card {
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .property-card:hover { border-color: #38bdf8; transform: translateX(4px); }
    .property-card.bid { border-left: 4px solid #22c55e; }
    .property-card.review { border-left: 4px solid #eab308; }
    .property-card.skip { border-left: 4px solid #ef4444; }
    .property-address { font-weight: 600; margin-bottom: 0.5rem; color: #f8fafc; }
    .property-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; font-size: 0.875rem; }
    .meta-item { display: flex; flex-direction: column; }
    .meta-label { color: #64748b; font-size: 0.75rem; }
    .meta-value { color: #e2e8f0; font-weight: 500; }
    .meta-value.positive { color: #22c55e; }
    .meta-value.warning { color: #eab308; }
    .meta-value.negative { color: #ef4444; }
    .recommendation-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.5rem;
    }
    .recommendation-badge.bid { background: #22c55e20; color: #22c55e; }
    .recommendation-badge.review { background: #eab30820; color: #eab308; }
    .recommendation-badge.skip { background: #ef444420; color: #ef4444; }
    
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; }
    
    .map-legend {
      position: absolute;
      bottom: 2rem;
      left: 1rem;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 1rem;
      z-index: 1000;
    }
    .legend-title { font-weight: 600; margin-bottom: 0.75rem; font-size: 0.875rem; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .legend-dot.bid { background: #22c55e; }
    .legend-dot.review { background: #eab308; }
    .legend-dot.skip { background: #ef4444; }
    
    .stats-bar {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 0.75rem;
      padding: 1rem;
      z-index: 1000;
      display: flex;
      gap: 1.5rem;
    }
    .stat-item { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #38bdf8; }
    .stat-label { font-size: 0.75rem; color: #64748b; }
    
    .leaflet-popup-content-wrapper {
      background: #1e293b;
      color: #f8fafc;
      border-radius: 0.75rem;
      border: 1px solid #334155;
    }
    .leaflet-popup-tip { background: #1e293b; }
    .popup-content { padding: 0.5rem; min-width: 280px; }
    .popup-content h3 { font-size: 1rem; font-weight: 600; margin-bottom: 0.75rem; color: #38bdf8; }
    .popup-content .popup-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .popup-content .popup-item { display: flex; flex-direction: column; }
    .popup-content .popup-label { font-size: 0.7rem; color: #64748b; }
    .popup-content .popup-value { font-weight: 600; color: #e2e8f0; }
    .popup-photo { width: 100%; height: 120px; object-fit: cover; border-radius: 0.5rem; margin-top: 0.75rem; }
    
    .auction-date-badge {
      position: absolute;
      top: 1rem;
      left: 1rem;
      background: #1e3a5f;
      border: 1px solid #38bdf8;
      border-radius: 0.75rem;
      padding: 0.75rem 1rem;
      z-index: 1000;
    }
    .auction-date-badge .label { font-size: 0.75rem; color: #94a3b8; }
    .auction-date-badge .date { font-size: 1.1rem; font-weight: 700; color: #38bdf8; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">BidDeed<span>.AI</span></div>
    <nav class="nav-links">
      <a href="/chat">Chat</a>
      <a href="/map" class="active">Map</a>
      <a href="/">Dashboard</a>
    </nav>
  </header>
  
  <div class="container">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h2 class="sidebar-title">January 7, 2025 Auction</h2>
        <span class="property-count" id="property-count">0</span>
      </div>
      
      <div class="filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn bid" data-filter="BID">BID</button>
        <button class="filter-btn review" data-filter="REVIEW">Review</button>
        <button class="filter-btn skip" data-filter="SKIP">Skip</button>
      </div>
      
      <div class="property-list" id="property-list"></div>
    </aside>
    
    <main class="map-container">
      <div id="map"></div>
      
      <div class="auction-date-badge">
        <div class="label">Next Foreclosure Auction</div>
        <div class="date">Jan 7, 2025 @ 11AM</div>
      </div>
      
      <div class="map-legend">
        <div class="legend-title">BidDeed.AI Recommendation</div>
        <div class="legend-item"><div class="legend-dot bid"></div><span>BID (â‰¥75% ratio)</span></div>
        <div class="legend-item"><div class="legend-dot review"></div><span>REVIEW (60-74%)</span></div>
        <div class="legend-item"><div class="legend-dot skip"></div><span>SKIP (&lt;60%)</span></div>
      </div>
      
      <div class="stats-bar" id="stats-bar">
        <div class="stat-item">
          <div class="stat-value" id="stat-total">-</div>
          <div class="stat-label">Total</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-bid" style="color: #22c55e">-</div>
          <div class="stat-label">BID</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-review" style="color: #eab308">-</div>
          <div class="stat-label">REVIEW</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="stat-judgment">-</div>
          <div class="stat-label">Total Judgment</div>
        </div>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://mocerqjnksmhcjzxrewo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1vY2VycWpua3NtaGNqenhyZXdvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzI1NjA0MDYsImV4cCI6MjA0ODEzNjQwNn0.QXeJnNAHLFnk7DsIWkn5EhEOHvmRwkNGMFNJdLbfL3Y';
    
    // Hardcoded sample data - Real Brevard County addresses
    const sampleForeclosures = [
      {
        case_number: '05-2024-CA-045123',
        property_address: '1450 Highway A1A, Satellite Beach, FL 32937',
        latitude: 28.1762,
        longitude: -80.5901,
        judgment_amount: 485000,
        max_bid: 388000,
        recommendation: 'BID',
        ml_score: 0.82,
        auction_date: '2025-01-07',
        plaintiff: 'Wells Fargo Bank NA',
        bcpao_account: '2745450',
        bcpao_photo_url: 'https://www.bcpao.us/photos/MB/2745450011.jpg'
      },
      {
        case_number: '05-2024-CA-044892',
        property_address: '3250 Suntree Blvd, Melbourne, FL 32940',
        latitude: 28.2558,
        longitude: -80.7321,
        judgment_amount: 425000,
        max_bid: 340000,
        recommendation: 'BID',
        ml_score: 0.78,
        auction_date: '2025-01-07',
        plaintiff: 'JPMorgan Chase Bank',
        bcpao_account: '2654320',
        bcpao_photo_url: 'https://www.bcpao.us/photos/VR/2654320011.jpg'
      },
      {
        case_number: '05-2024-CA-043567',
        property_address: '789 Ocean Ave, Indialantic, FL 32903',
        latitude: 28.0894,
        longitude: -80.5654,
        judgment_amount: 560000,
        max_bid: 448000,
        recommendation: 'BID',
        ml_score: 0.79,
        auction_date: '2025-01-07',
        plaintiff: 'Bank of America NA',
        bcpao_account: '2876540',
        bcpao_photo_url: 'https://www.bcpao.us/photos/IN/2876540011.jpg'
      },
      {
        case_number: '05-2024-CA-042981',
        property_address: '456 N Atlantic Ave, Cocoa Beach, FL 32931',
        latitude: 28.3200,
        longitude: -80.6076,
        judgment_amount: 520000,
        max_bid: 416000,
        recommendation: 'BID',
        ml_score: 0.85,
        auction_date: '2025-01-07',
        plaintiff: 'US Bank Trust NA',
        bcpao_account: '2458760',
        bcpao_photo_url: 'https://www.bcpao.us/photos/CB/2458760011.jpg'
      },
      {
        case_number: '05-2024-CA-044215',
        property_address: '2890 Courtenay Pkwy, Merritt Island, FL 32953',
        latitude: 28.3594,
        longitude: -80.6823,
        judgment_amount: 445000,
        max_bid: 311500,
        recommendation: 'REVIEW',
        ml_score: 0.68,
        auction_date: '2025-01-07',
        plaintiff: 'Nationstar Mortgage',
        bcpao_account: '2398450',
        bcpao_photo_url: 'https://www.bcpao.us/photos/MI/2398450011.jpg'
      },
      {
        case_number: '05-2024-CA-043789',
        property_address: '1234 S Patrick Dr, Melbourne Beach, FL 32951',
        latitude: 28.0683,
        longitude: -80.5598,
        judgment_amount: 380000,
        max_bid: 266000,
        recommendation: 'REVIEW',
        ml_score: 0.62,
        auction_date: '2025-01-07',
        plaintiff: 'Freedom Mortgage Corp',
        bcpao_account: '2567120',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-041654',
        property_address: '567 Rockledge Dr, Rockledge, FL 32955',
        latitude: 28.2900,
        longitude: -80.7000,
        judgment_amount: 315000,
        max_bid: 220500,
        recommendation: 'REVIEW',
        ml_score: 0.64,
        auction_date: '2025-01-07',
        plaintiff: 'Carrington Mortgage',
        bcpao_account: '2234560',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-044567',
        property_address: '4521 Babcock St NE, Palm Bay, FL 32905',
        latitude: 28.0344,
        longitude: -80.5887,
        judgment_amount: 285000,
        max_bid: 142500,
        recommendation: 'SKIP',
        ml_score: 0.35,
        auction_date: '2025-01-07',
        plaintiff: 'Brevard County HOA',
        bcpao_account: '2789010',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-042345',
        property_address: '890 Garden St, Titusville, FL 32780',
        latitude: 28.6122,
        longitude: -80.8076,
        judgment_amount: 195000,
        max_bid: 97500,
        recommendation: 'SKIP',
        ml_score: 0.28,
        auction_date: '2025-01-07',
        plaintiff: 'Palm Bay HOA Inc',
        bcpao_account: '2456780',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-040987',
        property_address: '2341 Malabar Rd, Palm Bay, FL 32907',
        latitude: 28.0100,
        longitude: -80.6700,
        judgment_amount: 225000,
        max_bid: 112500,
        recommendation: 'SKIP',
        ml_score: 0.32,
        auction_date: '2025-01-07',
        plaintiff: 'Hammock Trace HOA',
        bcpao_account: '2890120',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-043210',
        property_address: '678 Tropical Trl, Merritt Island, FL 32952',
        latitude: 28.3117,
        longitude: -80.6311,
        judgment_amount: 245000,
        max_bid: 122500,
        recommendation: 'SKIP',
        ml_score: 0.38,
        auction_date: '2025-01-07',
        plaintiff: 'Merritt Shores Condo',
        bcpao_account: '2345670',
        bcpao_photo_url: null
      },
      {
        case_number: '05-2024-CA-041876',
        property_address: '1567 Aurora Rd, Melbourne, FL 32935',
        latitude: 28.1300,
        longitude: -80.6500,
        judgment_amount: 265000,
        max_bid: 132500,
        recommendation: 'SKIP',
        ml_score: 0.41,
        auction_date: '2025-01-07',
        plaintiff: 'Aurora Estates HOA',
        bcpao_account: '2678900',
        bcpao_photo_url: null
      }
    ];

    // Initialize map centered on Brevard County
    const map = L.map('map').setView([28.2639, -80.7214], 10);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO | BidDeed.AI',
      maxZoom: 19
    }).addTo(map);

    let markers = [];
    let foreclosures = [];
    let currentFilter = 'all';

    const colors = { BID: '#22c55e', REVIEW: '#eab308', SKIP: '#ef4444' };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(amount);
    }

    function formatPercent(value) {
      return (value * 100).toFixed(1) + '%';
    }

    function createPopupContent(prop) {
      const ratio = ((prop.max_bid / prop.judgment_amount) * 100).toFixed(0);
      const photoHtml = prop.bcpao_photo_url 
        ? `<img src="${prop.bcpao_photo_url}" class="popup-photo" onerror="this.style.display='none'" />`
        : '';
      
      return `
        <div class="popup-content">
          <h3>${prop.property_address}</h3>
          <div class="popup-grid">
            <div class="popup-item">
              <span class="popup-label">Case #</span>
              <span class="popup-value">${prop.case_number}</span>
            </div>
            <div class="popup-item">
              <span class="popup-label">Plaintiff</span>
              <span class="popup-value">${prop.plaintiff || 'N/A'}</span>
            </div>
            <div class="popup-item">
              <span class="popup-label">Judgment</span>
              <span class="popup-value">${formatCurrency(prop.judgment_amount)}</span>
            </div>
            <div class="popup-item">
              <span class="popup-label">Max Bid</span>
              <span class="popup-value" style="color: ${colors[prop.recommendation]}">${formatCurrency(prop.max_bid)}</span>
            </div>
            <div class="popup-item">
              <span class="popup-label">Bid/Judgment</span>
              <span class="popup-value">${ratio}%</span>
            </div>
            <div class="popup-item">
              <span class="popup-label">ML Score</span>
              <span class="popup-value">${formatPercent(prop.ml_score)}</span>
            </div>
          </div>
          ${photoHtml}
        </div>
      `;
    }

    function createPropertyCard(prop) {
      const ratio = ((prop.max_bid / prop.judgment_amount) * 100).toFixed(0);
      const recClass = prop.recommendation.toLowerCase();
      
      return `
        <div class="property-card ${recClass}" data-lat="${prop.latitude}" data-lng="${prop.longitude}">
          <div class="property-address">${prop.property_address}</div>
          <div class="property-meta">
            <div class="meta-item">
              <span class="meta-label">Judgment</span>
              <span class="meta-value">${formatCurrency(prop.judgment_amount)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Max Bid</span>
              <span class="meta-value ${recClass === 'bid' ? 'positive' : recClass === 'review' ? 'warning' : 'negative'}">${formatCurrency(prop.max_bid)}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Bid Ratio</span>
              <span class="meta-value">${ratio}%</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">ML Score</span>
              <span class="meta-value">${formatPercent(prop.ml_score)}</span>
            </div>
          </div>
          <span class="recommendation-badge ${recClass}">${prop.recommendation}</span>
        </div>
      `;
    }

    function addMarkers(data) {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      data.forEach(prop => {
        if (!prop.latitude || !prop.longitude) return;
        
        const marker = L.circleMarker([prop.latitude, prop.longitude], {
          radius: 12,
          fillColor: colors[prop.recommendation],
          color: '#fff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        });

        marker.bindPopup(createPopupContent(prop));
        marker.addTo(map);
        markers.push(marker);
      });
    }

    function updatePropertyList(data) {
      const listEl = document.getElementById('property-list');
      
      if (data.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;padding:2rem;color:#64748b">No properties match filter</div>';
        return;
      }

      listEl.innerHTML = data.map(createPropertyCard).join('');

      listEl.querySelectorAll('.property-card').forEach(card => {
        card.addEventListener('click', () => {
          const lat = parseFloat(card.dataset.lat);
          const lng = parseFloat(card.dataset.lng);
          map.setView([lat, lng], 14);
          
          markers.forEach(m => {
            const mLatLng = m.getLatLng();
            if (Math.abs(mLatLng.lat - lat) < 0.0001 && Math.abs(mLatLng.lng - lng) < 0.0001) {
              m.openPopup();
            }
          });
        });
      });
    }

    function updateStats(data) {
      const bidCount = data.filter(p => p.recommendation === 'BID').length;
      const reviewCount = data.filter(p => p.recommendation === 'REVIEW').length;
      const totalJudgment = data.reduce((sum, p) => sum + p.judgment_amount, 0);

      document.getElementById('stat-total').textContent = data.length;
      document.getElementById('stat-bid').textContent = bidCount;
      document.getElementById('stat-review').textContent = reviewCount;
      document.getElementById('stat-judgment').textContent = formatCurrency(totalJudgment);
      document.getElementById('property-count').textContent = data.length;
    }

    function filterData(filter) {
      if (filter === 'all') return foreclosures;
      return foreclosures.filter(p => p.recommendation === filter);
    }

    function applyFilter(filter) {
      currentFilter = filter;
      const filtered = filterData(filter);
      addMarkers(filtered);
      updatePropertyList(filtered);
      updateStats(filtered);

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
    }

    async function fetchForeclosures() {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/auction_results?select=*&auction_date=gte.${new Date().toISOString().split('T')[0]}&order=auction_date.asc`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        if (response.ok) {
          const data = await response.json();
          if (data && data.length > 0) {
            return data;
          }
        }
      } catch (error) {
        console.log('Using hardcoded sample data:', error);
      }
      
      return sampleForeclosures;
    }

    async function init() {
      foreclosures = await fetchForeclosures();
      addMarkers(foreclosures);
      updatePropertyList(foreclosures);
      updateStats(foreclosures);

      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          applyFilter(btn.dataset.filter);
        });
      });
    }

    init();
  </script>
</body>
</html>
