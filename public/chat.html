<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f172a">
    <title>BrevardBidderAI Chat</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --accent: #3b82f6;
            --text-primary: #f0f0f5;
            --text-secondary: #a0a0b0;
            --user-bubble: #3b82f6;
            --claude-bubble: #334155;
        }
        
        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid rgba(59,130,246,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .title-area h1 { font-size: 1.1rem; }
        .title-area .status { 
            font-size: 0.75rem; 
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
        }
        .status-dot.working {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .message {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .message.user {
            background: var(--user-bubble);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message.assistant {
            background: var(--claude-bubble);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message pre {
            background: #1a1a2e;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 0.8rem;
        }
        
        .message code {
            font-family: 'SF Mono', Monaco, monospace;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        
        .progress-indicator {
            background: var(--claude-bubble);
            padding: 12px 16px;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            max-width: 85%;
            display: none;
        }
        
        .progress-indicator.visible { display: block; }
        
        .progress-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .progress-dots {
            display: flex;
            gap: 4px;
        }
        
        .progress-dots span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s ease-in-out infinite;
        }
        .progress-dots span:nth-child(2) { animation-delay: 0.16s; }
        .progress-dots span:nth-child(3) { animation-delay: 0.32s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
        
        .input-area {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-top: 1px solid rgba(59,130,246,0.2);
            flex-shrink: 0;
        }
        
        .quick-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .quick-btn {
            padding: 8px 14px;
            background: rgba(59,130,246,0.2);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 20px;
            color: var(--text-primary);
            font-size: 0.8rem;
            white-space: nowrap;
            cursor: pointer;
        }
        
        .quick-btn:active { background: rgba(59,130,246,0.4); }
        
        .input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        #messageInput {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 24px;
            color: var(--text-primary);
            font-size: 16px;
            resize: none;
            max-height: 120px;
            line-height: 1.4;
        }
        
        #messageInput:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        #sendBtn {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        #sendBtn:disabled { opacity: 0.5; }
        
        .login-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .login-box {
            background: var(--bg-secondary);
            padding: 32px;
            border-radius: 20px;
            width: 90%;
            max-width: 360px;
            text-align: center;
        }
        
        .login-box h2 { margin-bottom: 8px; }
        .login-box p { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.9rem; }
        
        .login-box input {
            width: 100%;
            padding: 14px;
            background: var(--bg-primary);
            border: 1px solid rgba(59,130,246,0.3);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 16px;
            margin-bottom: 16px;
        }
        
        .login-box button {
            width: 100%;
            padding: 14px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        
        .hidden { display: none !important; }
        
        .timeout-warning {
            background: rgba(245,158,11,0.2);
            border: 1px solid rgba(245,158,11,0.5);
            color: #fbbf24;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>üè† BrevardBidderAI</h2>
            <p>Foreclosure Intelligence Assistant</p>
            <input type="password" id="pwdInput" placeholder="Enter password">
            <button onclick="login()">Access</button>
        </div>
    </div>
    
    <div id="app" class="app hidden">
        <header>
            <div class="logo">üè†</div>
            <div class="title-area">
                <h1>BrevardBidderAI</h1>
                <div class="status">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="statusText">Ready</span>
                </div>
            </div>
        </header>
        
        <div class="messages" id="messages">
            <div class="message assistant">
                Welcome! I can analyze foreclosures, query auction data, search the web, and browse code repositories.<br><br>
                <strong>Tip:</strong> Complex queries may take 30-60 seconds as I search multiple sources.
            </div>
            
            <div class="progress-indicator" id="progress">
                <div class="progress-text" id="progressText">Thinking...</div>
                <div class="progress-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        </div>
        
        <div class="input-area">
            <div class="quick-btns">
                <button class="quick-btn" onclick="sendQuick('Show 5 recent auction results')">üìä Auctions</button>
                <button class="quick-btn" onclick="sendQuick('Explain max bid formula')">üí∞ Max Bid</button>
                <button class="quick-btn" onclick="sendQuick('List src in brevard-bidder-scraper')">üíª Code</button>
            </div>
            <div class="input-row">
                <textarea id="messageInput" rows="1" placeholder="Ask about foreclosures..." onkeydown="handleKey(event)"></textarea>
                <button id="sendBtn" onclick="sendMessage()">‚û§</button>
            </div>
            <div id="timeoutWarning" class="timeout-warning hidden">
                ‚è±Ô∏è Taking longer than expected. Complex queries may need 60+ seconds...
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/chat';
        let messages = [];
        let sessionId = 'bb_' + Date.now();
        
        // Auto-login
        const savedPwd = localStorage.getItem('brevard_pwd');
        if (savedPwd) {
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }
        
        document.getElementById('pwdInput').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });
        
        function login() {
            const pwd = document.getElementById('pwdInput').value;
            if (pwd) {
                localStorage.setItem('brevard_pwd', pwd);
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
            }
        }
        
        function setStatus(text, working = false) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('statusDot').classList.toggle('working', working);
        }
        
        function showProgress(text) {
            document.getElementById('progressText').textContent = text;
            document.getElementById('progress').classList.add('visible');
            scrollToBottom();
        }
        
        function hideProgress() {
            document.getElementById('progress').classList.remove('visible');
        }
        
        function scrollToBottom() {
            const msgs = document.getElementById('messages');
            msgs.scrollTop = msgs.scrollHeight;
        }
        
        function addMessage(role, content) {
            const msgs = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            
            // Simple markdown
            let html = content
                .replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/##\s+(.+)/g, '<strong>$1</strong><br>')
                .replace(/###\s+(.+)/g, '<strong>$1</strong><br>')
                .replace(/\n/g, '<br>');
            
            div.innerHTML = html;
            msgs.insertBefore(div, document.getElementById('progress'));
            scrollToBottom();
        }
        
        function sendQuick(text) {
            document.getElementById('messageInput').value = text;
            sendMessage();
        }
        
        function handleKey(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            if (!content) return;
            
            input.value = '';
            addMessage('user', content);
            messages.push({ role: 'user', content });
            
            document.getElementById('sendBtn').disabled = true;
            setStatus('Working...', true);
            showProgress('üîç Analyzing your request...');
            document.getElementById('timeoutWarning').classList.add('hidden');
            
            // Show timeout warning after 15 seconds
            const timeoutTimer = setTimeout(() => {
                showProgress('üîß Using tools to find data...');
                document.getElementById('timeoutWarning').classList.remove('hidden');
            }, 15000);
            
            // Update progress messages
            const progressMessages = [
                'üìä Querying database...',
                'üåê Searching web...',
                'üìù Generating report...'
            ];
            let progressIndex = 0;
            const progressTimer = setInterval(() => {
                if (progressIndex < progressMessages.length) {
                    showProgress(progressMessages[progressIndex]);
                    progressIndex++;
                }
            }, 8000);
            
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 120000); // 2 min timeout
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        password: localStorage.getItem('brevard_pwd'),
                        messages: messages,
                        session_id: sessionId
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeout);
                clearTimeout(timeoutTimer);
                clearInterval(progressTimer);
                
                if (response.status === 401) {
                    localStorage.removeItem('brevard_pwd');
                    location.reload();
                    return;
                }
                
                const data = await response.json();
                
                if (data.error) {
                    addMessage('assistant', '‚ö†Ô∏è Error: ' + data.error);
                } else {
                    const textContent = data.content?.filter(b => b.type === 'text').map(b => b.text).join('\n\n') || 'No response received.';
                    addMessage('assistant', textContent);
                    messages.push({ role: 'assistant', content: textContent });
                }
                
            } catch (error) {
                clearTimeout(timeoutTimer);
                clearInterval(progressTimer);
                
                if (error.name === 'AbortError') {
                    addMessage('assistant', '‚è±Ô∏è Request timed out. Try a simpler query or break it into steps.');
                } else {
                    addMessage('assistant', '‚ö†Ô∏è Connection error: ' + error.message);
                }
            }
            
            hideProgress();
            document.getElementById('timeoutWarning').classList.add('hidden');
            document.getElementById('sendBtn').disabled = false;
            setStatus('Ready', false);
        }
    </script>
</body>
</html>
